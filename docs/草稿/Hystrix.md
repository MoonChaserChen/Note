# Hystrix
hystrix的四大功能：隔离、限流、熔断和降级
## 服务隔离
减少同一个系统不同服务之间的相互影响。隔离策略可以分线程池隔离与信息量隔离
> 比如我们现在有3个业务调用分别是查询订单、查询商品、查询用户，且这三个业务请求都是依赖第三方服务-订单服务、商品服务、用户服务。三个服务均是通过RPC调用。
>当查询订单服务，假如线程阻塞了，这个时候后续有大量的查询订单请求过来，那么容器中的线程数量则会持续增加直致CPU资源耗尽到100%，整个服务对外不可用，集群环境下就是雪崩。

### 信号量隔离
当 n 个并发请求去调用一个目标服务接口时，都要获取一个信号量（默认是 10 个，可以使用 maxConcurrentRequests 参数配置）才能真正去调用目标服务接口，
如果并发请求数多于信号量个数，就有线程需要进入有界队列排队（默认队列长度为5），如果排队队列也满，则必定有请求线程会走 fallback 流程，从而达到限流和防止雪崩的目的。
### 线程池隔离
1. Hystrix通过命令模式，将每个类型的业务请求封装成对应的命令请求Command，每个类型的Command对应一个线程池。创建好的线程池是被放入到ConcurrentHashMap。
2. 当某类型的请求过来的时候，则可以直接从Map中获取该线程池
3. Hystrix是结合RxJava来实现的异步编程
### 对比
|  | 是否有上下文切换 | 是否支撑异步 | 是否支持超时 | 是否支撑熔断 | 开销 | 是否支持限流 |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 信号量 | 否 | 否 | 否 | 是 | 小 | 是 |
| 线程池 | 是 | 是 | 是 | 是 | 大 | 是 |
> 信号量的大小可以动态调整, 线程池大小不可以

## 熔断器机制
- closed
1. 请求正常时，不使用熔断器；
2. 统计请求的失败比例，达到阀值时，打开熔断器，进入open状态；
> 默认失败比例阀值是50%，请求次数最少不低于20次(例如：一段时间内请求30次，有20失败，熔断器将会打开，默认5s内的请求都会失败，直接返回。)
> Hystrix默认的超时时间为1s，请求时间超过1s，熔断次数加1
- open
1. open状态（熔断器打开），所有请求被降级处理
2. 延时一段时候后（默认休眠时间是5S）会进入halfopen状态；
- halfopen
1. 在进入该状态后会放入部分请求；判断请求是否成功，不成功，进入open状态，重新计时，进入halfopen状态；成功，进入closed状态，重新计数


